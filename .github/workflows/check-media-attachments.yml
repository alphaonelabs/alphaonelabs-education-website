name: Check PR for Screenshots when HTML changes

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.html'

jobs:
  check-for-screenshots:
    runs-on: ubuntu-latest
    name: Check for PR screenshots
    permissions:
      contents: read
      pull-requests: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for screenshots in PR description or comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const botCommentIdentifier = '<!-- media-check-bot -->';

            console.log(`Checking PR #${prNumber} for screenshots because HTML files were changed.`);

            // --- 1. Get PR body + comments ---
            const prBody = context.payload.pull_request.body || '';

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const allCommentsText = comments.map(comment => comment.body || '').join('\n');
            const combinedText = prBody + '\n' + allCommentsText;

            // --- 2. Look for actual media (image/video uploads) ---
            const mediaRegex = /(https:\/\/user-images\.githubusercontent\.com\/\d+\/.+\.(png|jpe?g|gif|webp|mp4|mov))|(!\[.*\]\(.*\.(png|jpe?g|gif|webp)\))/i;
            const mediaFound = mediaRegex.test(combinedText);

            // --- 3. Find previous bot comment ---
            const botComment = comments.find(comment =>
              comment.user?.login === 'github-actions[bot]' &&
              comment.body?.includes(botCommentIdentifier)
            );

            if (mediaFound) {
              console.log('âœ… Screenshot or media found in the PR.');
              if (botComment) {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                });
                console.log('Removed previous warning comment.');
              }
              return;
            }

            // --- 4. Post or update warning comment ---
            const commentBody = `${botCommentIdentifier}

            ## Screenshot Missing

            You've modified **HTML files**, but no screenshots or recordings were found in the PR description or comments.

            *Please attach a screenshot or GIF demonstrating the change.*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: commentBody,
              });
              console.log('Updated existing warning comment.');
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('Created a new warning comment.');
            }

            // --- 5. Fail workflow to block merging ---
            core.setFailed('Missing screenshots for HTML changes. Please add one to continue.');
