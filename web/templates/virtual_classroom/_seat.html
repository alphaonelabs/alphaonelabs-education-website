{% load static %}
<div id="seat-{{ seat.id }}" 
     class="seat relative w-32 h-32 transition-all duration-300 ease-in-out"
     data-row="{{ seat.row }}"
     data-col="{{ seat.column }}"
     data-id="{{ seat.id }}"
     data-status="{{ seat.status }}"
     {% if not request.user == seat.classroom.session.course.teacher %}
     hx-post="{% url 'select_seat' seat.classroom.id %}"
     hx-trigger="click"
     hx-target="#seating-grid"
     hx-swap="outerHTML"
     hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
     hx-vals='{"row": {{ seat.row }}, "column": {{ seat.column }}, "previous_seat_id": "{{ request.user.virtualseat_set.first.id|default:'' }}"}'
     {% endif %}>
     
    <!-- Fixed aspect ratio container -->
    <div class="absolute inset-0 flex flex-col items-center justify-center">
        <!-- Core seat content -->
        <div class="w-full h-full flex items-center justify-center rounded-lg p-2 border-2
            {% if seat.status == 'empty' %} 
                bg-gray-100 hover:bg-gray-200 cursor-pointer
            {% elif seat.status == 'occupied' %} 
                bg-green-100 border-green-300
            {% elif seat.status == 'hand_raised' %} 
                bg-yellow-100 border-yellow-400
            {% elif seat.status == 'speaking' %} 
                bg-blue-100 border-blue-400 animate-pulse
            {% endif %}">
            
            <!-- Consistent content container -->
            <div class="w-full h-full flex flex-col items-center justify-center">
                {% if seat.student %}
                <div class="avatar-container mb-1">
                    <div class="w-8 h-8 mx-auto bg-gray-300 rounded-full flex items-center justify-center 
                              text-gray-700 font-bold overflow-hidden">
                        {% if seat.student.profile.avatar %}
                        <img src="{{ seat.student.profile.avatar.url }}" 
                             class="w-full h-full object-cover"
                             alt="{{ seat.student.username }}">
                        {% else %}
                        {{ seat.student.username|first|upper }}
                        {% endif %}
                    </div>
                </div>
                <div class="username text-xs font-medium truncate max-w-[90%]">
                    {{ seat.student.username }}
                </div>
                {% else %}
                <div class="empty-state text-xs text-gray-500 px-2 text-center">
                    Empty Seat
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action buttons (consistent positioning) -->
    <div class="absolute bottom-1 right-1 flex gap-1">
        {% if seat.student %}
        <!-- Laptop toggle -->
        <button class="laptop-toggle bg-white rounded-full p-1 shadow-sm hover:shadow-md 
                      w-6 h-6 flex items-center justify-center transition-shadow"
                data-seat-id="{{ seat.id }}"
                hx-post="{% url 'toggle_laptop' %}"
                hx-trigger="click"
                hx-target="#seating-grid"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
            <svg class="w-4 h-4 {% if seat.laptop_open %}text-blue-500{% else %}text-gray-600{% endif %}" 
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
        </button>
        {% endif %}

        <!-- Hand raise (only for current user) -->
        {% if seat.student == request.user %}
        <button class="hand-raise-toggle bg-white rounded-full p-1 shadow-sm hover:shadow-md 
                      w-6 h-6 flex items-center justify-center transition-shadow"
                hx-post="{% url 'raise_hand' %}"
                hx-trigger="click"
                hx-target="#seating-grid"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
            <svg class="w-4 h-4 {% if seat.status == 'hand_raised' %}text-yellow-500{% else %}text-gray-600{% endif %}" 
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/>
            </svg>
        </button>
        {% endif %}
    </div>

    <!-- Status indicators -->
    {% if seat.status == 'hand_raised' %}
    <div class="absolute top-[-8px] left-1/2 transform -translate-x-1/2">
        <div class="animate-bounce">
            <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
        </div>
    </div>
    {% endif %}
</div>