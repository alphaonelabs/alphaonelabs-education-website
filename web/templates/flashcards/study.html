{% extends "base.html" %}
{% load static %}

{% block title %}
  Study: {{ deck.name }}
{% endblock title %}

{% block content %}
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <a href="{% url 'flashcard_deck_detail' deck.slug %}"
             class="text-teal-600 hover:text-teal-700 dark:text-teal-400 dark:hover:text-teal-300">
            <i class="fas fa-arrow-left mr-2"></i>Back to {{ deck.name }}
          </a>

          <div class="text-sm text-gray-500 dark:text-gray-400">
            <span id="current-card">1</span> / {{ card_count }}
          </div>
        </div>

        <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">
          <i class="fas fa-graduation-cap mr-3 text-teal-500"></i>Study: {{ deck.name }}
        </h1>
        <p class="text-gray-600 dark:text-gray-300">Click the card to reveal the answer</p>
      </div>

      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div id="progress-bar" class="bg-teal-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>

      <!-- Flashcard -->
      <div class="mb-8">
        <div id="flashcard" class="relative w-full h-96 cursor-pointer" onclick="flipCard()">
          <div id="card-inner" class="relative w-full h-full text-center transition-transform duration-600 transform-style-preserve-3d">
            <!-- Front of card -->
            <div id="card-front" class="absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 flex items-center justify-center p-8 backface-hidden">
              <div class="w-full">
                <div class="mb-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    <i class="fas fa-question-circle mr-2"></i>Question
                  </span>
                </div>
                <div id="front-content" class="text-xl text-gray-900 dark:text-white whitespace-pre-wrap">
                  <!-- Front content will be inserted here -->
                </div>
                <div class="mt-6 text-sm text-gray-500 dark:text-gray-400">
                  <i class="fas fa-mouse-pointer mr-2"></i>Click to reveal answer
                </div>
              </div>
            </div>

            <!-- Back of card -->
            <div id="card-back" class="absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 flex items-center justify-center p-8 backface-hidden transform rotateY-180">
              <div class="w-full">
                <div class="mb-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                    <i class="fas fa-lightbulb mr-2"></i>Answer
                  </span>
                </div>
                <div id="back-content" class="text-xl text-gray-900 dark:text-white whitespace-pre-wrap">
                  <!-- Back content will be inserted here -->
                </div>
                <div class="mt-6 text-sm text-gray-500 dark:text-gray-400">
                  <i class="fas fa-mouse-pointer mr-2"></i>Click to show question
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="flex justify-between items-center">
        <button id="prev-btn"
                onclick="previousCard()"
                class="bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-200 inline-flex items-center">
          <i class="fas fa-chevron-left mr-2"></i>Previous
        </button>

        <div class="text-center">
          <button onclick="shuffleCards()"
                  class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 inline-flex items-center mr-3">
            <i class="fas fa-random mr-2"></i>Shuffle
          </button>
          <button onclick="restartDeck()"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 inline-flex items-center">
            <i class="fas fa-redo mr-2"></i>Restart
          </button>
        </div>

        <button id="next-btn"
                onclick="nextCard()"
                class="bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-200 inline-flex items-center">
          Next<i class="fas fa-chevron-right ml-2"></i>
        </button>
      </div>

      <!-- Study Complete Modal -->
      <div id="complete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-md mx-4">
          <div class="text-center">
            <div class="mb-4">
              <i class="fas fa-trophy text-4xl text-yellow-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Study Complete!</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">You've studied all {{ card_count }} cards in this deck.</p>
            <div class="flex space-x-3 justify-center">
              <button onclick="restartDeck()"
                      class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Study Again
              </button>
              <a href="{% url 'flashcard_deck_detail' deck.slug %}"
                 class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Back to Deck
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .transform-style-preserve-3d {
      transform-style: preserve-3d;
    }
    .backface-hidden {
      backface-visibility: hidden;
    }
    .rotateY-180 {
      transform: rotateY(180deg);
    }
    .card-flipped {
      transform: rotateY(180deg);
    }
  </style>

  <script>
    // Cards data from Django
    const cards = [
      {% for card in cards %}
        {
          id: {{ card.id }},
          front: {{ card.front_text|escapejs }},
          back: {{ card.back_text|escapejs }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    let currentCardIndex = 0;
    let isFlipped = false;

    // Use the cards directly (they're already in the right format)
    const flashcards = cards;

    function updateCard() {
      const card = flashcards[currentCardIndex];
      document.getElementById('front-content').textContent = card.front;
      document.getElementById('back-content').textContent = card.back;

      // Reset card to front side
      isFlipped = false;
      document.getElementById('card-inner').classList.remove('card-flipped');

      // Update counter and progress
      document.getElementById('current-card').textContent = currentCardIndex + 1;
      const progress = ((currentCardIndex + 1) / flashcards.length) * 100;
      document.getElementById('progress-bar').style.width = progress + '%';

      // Update navigation buttons
      document.getElementById('prev-btn').disabled = currentCardIndex === 0;
      document.getElementById('next-btn').disabled = currentCardIndex === flashcards.length - 1;
    }

    function flipCard() {
      isFlipped = !isFlipped;
      document.getElementById('card-inner').classList.toggle('card-flipped');
    }

    function nextCard() {
      if (currentCardIndex < flashcards.length - 1) {
        currentCardIndex++;
        updateCard();
      } else {
        // Show completion modal
        document.getElementById('complete-modal').classList.remove('hidden');
      }
    }

    function previousCard() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        updateCard();
      }
    }

    function shuffleCards() {
      // Fisher-Yates shuffle algorithm
      for (let i = flashcards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
      }
      currentCardIndex = 0;
      updateCard();
    }

    function restartDeck() {
      currentCardIndex = 0;
      updateCard();
      document.getElementById('complete-modal').classList.add('hidden');
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
      switch(event.code) {
        case 'Space':
        case 'Enter':
          event.preventDefault();
          flipCard();
          break;
        case 'ArrowLeft':
          event.preventDefault();
          previousCard();
          break;
        case 'ArrowRight':
          event.preventDefault();
          nextCard();
          break;
      }
    });

    // Close modal when clicking outside
    document.getElementById('complete-modal').addEventListener('click', function(event) {
      if (event.target === this) {
        this.classList.add('hidden');
      }
    });

    // Initialize the first card
    updateCard();
  </script>
{% endblock content %}
