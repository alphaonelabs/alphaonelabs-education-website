{% extends "web/base.html" %}

{% load static %}

{% block title %}{{ title }}{% endblock %}
{% block content %}
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 shadow-md rounded-lg p-6">
      <h1 class="text-2xl font-bold mb-6">{{ title }}</h1>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-6">
          <label for="id_question_type"
                 class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question Type</label>
          {{ form.question_type }}
          {% if form.question_type.errors %}<p class="text-red-500 text-xs mt-1">{{ form.question_type.errors }}</p>{% endif %}
        </div>
        <div class="mb-6">
          <label for="id_text"
                 class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question Text</label>
          {{ form.text }}
          {% if form.text.errors %}<p class="text-red-500 text-xs mt-1">{{ form.text.errors }}</p>{% endif %}
        </div>
        <div class="mb-6">
          <label for="id_points"
                 class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Points</label>
          {{ form.points }}
          {% if form.points.errors %}<p class="text-red-500 text-xs mt-1">{{ form.points.errors }}</p>{% endif %}
        </div>
        <div class="mb-6">
          <label for="id_image"
                 class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Image (optional)</label>
          {{ form.image }}
          {% if form.image.errors %}<p class="text-red-500 text-xs mt-1">{{ form.image.errors }}</p>{% endif %}
        </div>
        <!-- Multiple Choice Options -->
        <div id="multiple_choice_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Options</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
            Add answer options below. Check the box for correct answer(s).
          </p>
          {{ formset.management_form }}
          <div class="space-y-3">
            {% for option_form in formset %}
              <div class="option-form flex items-center space-x-3">
                <div class="flex-1">
                  {{ option_form.text }}
                  {% if option_form.text.errors %}<p class="text-red-500 text-xs mt-1">{{ option_form.text.errors }}</p>{% endif %}
                </div>
                <div class="flex items-center">
                  <label class="mr-2 text-sm text-gray-600 dark:text-gray-400">Correct</label>
                  {{ option_form.is_correct }}
                </div>
                {% if formset.can_delete %}
                  <div class="delete-option">
                    {{ option_form.DELETE }}
                    <label for="{{ option_form.DELETE.id_for_label }}"
                           class="text-red-500 cursor-pointer">
                      <i class="fas fa-trash"></i>
                    </label>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        <!-- True/False Options -->
        <div id="true_false_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">True/False</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Select the correct answer.</p>
          <div class="flex space-x-6">
            <div class="flex items-center">
              <input type="radio"
                     name="true_false_answer"
                     id="answer_true"
                     value="true"
                     class="mr-2" />
              <label for="answer_true">True</label>
            </div>
            <div class="flex items-center">
              <input type="radio"
                     name="true_false_answer"
                     id="answer_false"
                     value="false"
                     class="mr-2" />
              <label for="answer_false">False</label>
            </div>
          </div>
        </div>
        <!-- Short Answer Options -->
        <div id="short_answer_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Short Answer</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Students will provide a short text answer.</p>
        </div>
        <!-- Fill in the Blank Options -->
        <div id="fill_blank_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Fill in the Blank</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
            Create a sentence with blanks using underscores (e.g., "The capital of France is _____").
          </p>
        </div>
        <!-- Open-Ended Options -->
        <div id="open_ended_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Open-Ended Question</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Students will provide a longer written response.</p>
        </div>
        <!-- Matching Options -->
        <div id="matching_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Matching Question</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Add items to match in pairs.</p>
          <div id="matching_items_container" class="space-y-2 mt-3">
            <!-- Matching items will be added here dynamically -->
          </div>
          <button type="button"
                  id="add_matching_item"
                  class="mt-3 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
            <i class="fas fa-plus mr-1"></i>Add Pair
          </button>
        </div>
        <!-- Problem-Solving Options -->
        <div id="problem_solving_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Problem-Solving Question</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Students will solve a problem and provide their solution.</p>
        </div>
        <!-- Scenario-Based Options -->
        <div id="scenario_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Scenario-Based Question</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Students will respond to a described scenario.</p>
        </div>
        <!-- Diagram-Based Options -->
        <div id="diagram_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Diagram-Based Question</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
            Upload a diagram image and students will identify components.
          </p>
        </div>
        <!-- Coding Options -->
        <div id="coding_options"
             class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
          <h3 class="text-lg font-medium mb-3">Coding Question</h3>
          <div class="mb-4">
            <label for="id_code_starter"
                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Starter Code (shown to student)
            </label>
            {{ form.code_starter }}
            {% if form.code_starter.errors %}<p class="text-red-500 text-xs mt-1">{{ form.code_starter.errors }}</p>{% endif %}
          </div>
          <div>
            <label for="id_expected_output"
                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Output</label>
            {{ form.expected_output }}
            {% if form.expected_output.errors %}
              <p class="text-red-500 text-xs mt-1">{{ form.expected_output.errors }}</p>
            {% endif %}
          </div>
        </div>
        <!-- Explanation field for all question types -->
        <div class="mb-6">
          <label for="id_explanation"
                 class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Explanation (shown after quiz)
          </label>
          {{ form.explanation }}
          {% if form.explanation.errors %}<p class="text-red-500 text-xs mt-1">{{ form.explanation.errors }}</p>{% endif %}
        </div>
        <div class="flex space-x-3">
          <button type="submit"
                  name="save"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Question</button>
          <button type="submit"
                  name="save_and_add"
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Save and Add Another</button>
          <a href="{% url 'quiz_detail' quiz.id %}"
             class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancel</a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Question type specific forms
          const questionTypeSelect = document.getElementById('id_question_type');
          const questionFormAreas = {
              multiple: document.getElementById('multiple_choice_options'),
              true_false: document.getElementById('true_false_options'),
              short: document.getElementById('short_answer_options'),
              fill_blank: document.getElementById('fill_blank_options'),
              open_ended: document.getElementById('open_ended_options'),
              matching: document.getElementById('matching_options'),
              problem_solving: document.getElementById('problem_solving_options'),
              scenario: document.getElementById('scenario_options'),
              diagram: document.getElementById('diagram_options'),
              coding: document.getElementById('coding_options')
          };

          // Show/hide appropriate form sections based on question type
          function updateFormSections() {
              if (!questionTypeSelect) return;

              const selectedType = questionTypeSelect.value;

              // Hide all sections first
              Object.values(questionFormAreas).forEach(area => {
                  if (area) area.classList.add('hidden');
              });

              // Show selected section
              if (questionFormAreas[selectedType]) {
                  questionFormAreas[selectedType].classList.remove('hidden');
              }
          }

          // Add item to matching questions
          const addMatchingItemBtn = document.getElementById('add_matching_item');
          if (addMatchingItemBtn) {
              addMatchingItemBtn.addEventListener('click', function() {
                  const matchingItemsContainer = document.getElementById('matching_items_container');
                  const itemCount = matchingItemsContainer.querySelectorAll('.matching-item-row').length;

                  const itemHtml = `
                    <div class="matching-item-row flex items-center gap-2 mb-2">
                        <input type="text" name="matching_item[]" class="border rounded p-2 flex-1" placeholder="Item ${itemCount + 1}" />
                        <span class="text-gray-500">→</span>
                        <input type="text" name="matching_match[]" class="border rounded p-2 flex-1" placeholder="Match ${itemCount + 1}" />
                        <button type="button" class="remove-matching-item px-2 py-1 bg-red-500 text-white rounded">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                  matchingItemsContainer.insertAdjacentHTML('beforeend', itemHtml);

                  // Add event listener to the new remove button
                  const newRemoveBtn = matchingItemsContainer.querySelector('.matching-item-row:last-child .remove-matching-item');
                  newRemoveBtn.addEventListener('click', function() {
                      this.closest('.matching-item-row').remove();
                  });
              });

              // Add initial pair
              addMatchingItemBtn.click();
          }

          // Set up event delegation for remove buttons in matching items
          const matchingItemsContainer = document.getElementById('matching_items_container');
          if (matchingItemsContainer) {
              matchingItemsContainer.addEventListener('click', function(e) {
                  if (e.target.closest('.remove-matching-item')) {
                      e.target.closest('.matching-item-row').remove();
                  }
              });
          }

          // Initialize form visibility
          if (questionTypeSelect) {
              questionTypeSelect.addEventListener('change', updateFormSections);
              // Initial call to set correct visibility
              updateFormSections();
          }
      });
  </script>
{% endblock %}
