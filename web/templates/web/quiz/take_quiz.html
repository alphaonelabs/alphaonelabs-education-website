{% extends "base.html" %}

{% load static %}

{% block title %}
  Taking: {{ quiz.title }}
{% endblock title %}
{% block extra_head %}
  {{ block.super }}
  <script>
      function setupQuizStatePersistence() {
          const quizForm = document.getElementById('quiz-form');
          const userQuizId = "{{ user_quiz.id }}";
          const storageKey = `quiz_${userQuizId}_answers`;
          let autoSaveTimer = null;

          // Initialize state persistence
          function init() {
              if (!quizForm) return;

              // Check if sessionStorage is available
              const storageAvailable = (function() {
                  try {
                      const test = '__storage_test__';
                      sessionStorage.setItem(test, test);
                      sessionStorage.removeItem(test);
                      return true;
                  } catch (e) {
                      console.warn('sessionStorage is not available. Quiz state will not be saved.');
                      return false;
                  }
              })();

              if (storageAvailable) {
                  // Restore saved answers when page loads
                  restoreFormState();
                  // Save answers when they change
                  quizForm.addEventListener('input', saveFormState);
                  // Setup auto-save every 3 seconds
                  autoSaveTimer = setInterval(saveFormState, 3000);
              }

              // Clear timer and storage when form is submitted normally
              quizForm.addEventListener('submit', function() {
                  if (storageAvailable) {
                      clearInterval(autoSaveTimer);
                      sessionStorage.removeItem(storageKey);
                  }
              });

              console.log(`Quiz state persistence initialized ${storageAvailable ? 'with' : 'without'} sessionStorage`);
          }

          // Save all form answers to sessionStorage
          function saveFormState() {
              if (!quizForm) return;

              const formData = {};
              const inputs = quizForm.querySelectorAll('input, textarea, select');

              // Process each form element
              inputs.forEach(input => {
                  if (!input.name) return;

                  // Handle different input types
                  if (input.type === 'checkbox') {
                      // accumulate an array of checked values
                      formData[input.name] = formData[input.name] || [];
                      if (input.checked) {
                          formData[input.name].push(input.value);
                      }
                  } else if (input.type === 'radio') {
                      if (input.checked) {
                          formData[input.name] = input.value;
                      }
                  } else if (input.type === 'select-multiple') {
                      const selectedOptions = Array.from(input.selectedOptions).map(opt => opt.value);
                      formData[input.name] = selectedOptions;
                  } else {
                      formData[input.name] = input.value;
                  }
              });

              // Save to sessionStorage
              try {
                  sessionStorage.setItem(storageKey, JSON.stringify(formData));
                  console.log("Quiz state saved to sessionStorage");
              } catch (error) {
                  console.error("Failed to save quiz state:", error);
              }
          }

          // Restore form state from sessionStorage
          function restoreFormState() {
              try {
                  const saved = sessionStorage.getItem(storageKey);
                  if (!saved) return;

                  const formData = JSON.parse(saved);

                  // Restore each form element
                  Object.entries(formData).forEach(([name, value]) => {
                      const elements = quizForm.querySelectorAll(`[name="${name}"]`);

                      elements.forEach(element => {
                          if (element.type === 'checkbox') {
                              element.checked = Array.isArray(value) && value.includes(element.value);
                          } else if (element.type === 'radio') {
                              element.checked = (element.value === value);
                          } else if (element.type === 'select-multiple' && Array.isArray(value)) {
                              Array.from(element.options).forEach(option => {
                                  option.selected = value.includes(option.value);
                              });
                          } else {
                              element.value = value;
                          }
                      });
                  });

                  console.log("Quiz state restored from sessionStorage");
              } catch (error) {
                  console.error("Failed to restore quiz state:", error);
              }
          }

          // Start the module
          init();
      }

      // QUIZ SECURITY CONFIGURATION
      const quizSecurityData = {
          userQuizId: "{{ user_quiz.id }}",
          csrfToken: "{{ csrf_token }}"
      };

      // STATE VARIABLES
      let isQuizSubmitted = false;

      // Initialize everything when document is ready
      document.addEventListener('DOMContentLoaded', function() {
          setupQuizStatePersistence();
          hideFooterAndHeader()

          // Check if we have a time limit
          const timeLimit = parseInt("{{ quiz.time_limit|default:0 }}");
          if (timeLimit > 0) {
              let remainingTime = parseFloat("{{ remaining_time|default:0 }}");

              const timerElement = document.getElementById('timer');
              if (!timerElement) return; // Exit if timer element doesn't exist

              // Format and display initial time
              const initialMinutes = Math.floor(remainingTime / 60);
              const initialSeconds = remainingTime % 60;
              timerElement.innerText = `${initialMinutes.toString().padStart(2, '0')}:${initialSeconds.toString().padStart(2, '0')}`;

              // Update the timer every second
              const timerInterval = setInterval(function() {
                  remainingTime--;

                  // Store the remaining time in localStorage
                  localStorage.setItem('quiz_' + quizSecurityData.userQuizId + '_remaining_time', remainingTime.toString());

                  // Format the time as MM:SS
                  const minutes = Math.floor(remainingTime / 60);
                  const seconds = remainingTime % 60;
                  timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                  // Visual cues when time is running low
                  if (remainingTime <= 60) { // last minute
                      timerElement.classList.add('text-red-600', 'dark:text-red-400');
                      if (remainingTime <= 10) { // last 10 seconds
                          timerElement.classList.add('animate-pulse');
                      }
                  }

                  // Auto-submit when time is up
                  if (remainingTime <= 0) {
                      clearInterval(timerInterval);
                      localStorage.removeItem('quiz_' + quizSecurityData.userQuizId + '_remaining_time');
                      document.getElementById('quiz-form').submit();
                  }
              }, 1000);

              // Add event listener to the form submission to clear the timer
              document.getElementById('quiz-form').addEventListener('submit', function() {
                  clearInterval(timerInterval);
                  localStorage.removeItem('quiz_' + quizSecurityData.userQuizId + '_remaining_time');
                  // Save the remaining time in the hidden field for server-side processing
                  document.getElementById('quiz_timer_value').value = remainingTime;
              });
          }

      });


      function closeWarningMessage() {
          const messageButton = document.querySelector("#hideWarningButton");
          if (!messageButton) return;
          const messageDiv = messageButton.closest('.quiz-warning');
          if (messageDiv) messageDiv.remove();
      }

      function hideFooterAndHeader() {
          const header = document.querySelector("header");
          const footer = document.querySelector("footer");

          if (header) header.innerHTML = "";
          if (footer && typeof footer.remove === "function") footer.remove();
      }
  </script>
  {% if not quiz.enable_copy_paste_and_text_selection %}
    <style>
        /* Disable right-click menu */
        .quiz-content {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
  {% endif %}
  <style>
      /* Warn users when they first enter */
      .quiz-warning {
          background-color: #fed7d7;
          color: #822727;
          padding: 1rem;
          margin-bottom: 1rem;
          border-radius: 0.375rem;
          border-left: 4px solid #e53e3e;
      }
  </style>
{% endblock extra_head %}
{% block content %}
  <div class="quiz-content">
    <!-- Quiz content here -->
    <div class="container mx-auto px-4 py-8">
      <!-- Warning message -->
      <div class="quiz-warning mb-6 relative">
        <h3 class="font-bold text-lg mb-2">
          <i class="fas fa-exclamation-triangle mr-2"></i>Important Notice
        </h3>
        <p>
          Once you start this quiz, you must complete it in a single session. If you navigate away from this page or close your browser, your attempt will be automatically submitted and counted without any answers and you will take Zero.
        </p>
        <button onclick="closeWarningMessage()">
          <i id="hideWarningButton"
             class="fas fa-x text-blue-600 dark:text-blue-400 mr-2 absolute top-[5px] right-[5px] p-[6px] cursor-pointer"></i>
        </button>
      </div>
      <!-- Quiz Header -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
        <div class="p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">{{ quiz.title }}</h1>
              <div class="flex flex-wrap items-center text-sm text-gray-600 dark:text-gray-400">
                <span class="mr-4"><i class="fas fa-user mr-1"></i> By {{ quiz.creator.username }}</span>
                <span class="mr-4"><i class="fas fa-question-circle mr-1"></i> {{ questions|length }} questions</span>
                {% if quiz.subject %}<span><i class="fas fa-book mr-1"></i> {{ quiz.subject.name }}</span>{% endif %}
              </div>
            </div>
            <!-- Timer and Progress -->
            <div class="flex items-center space-x-4">
              {% if quiz.time_limit %}
                <div class="flex items-center bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-lg">
                  <i class="fas fa-clock text-gray-600 dark:text-gray-400 mr-2"></i>
                  <span id="timer" class="text-xl font-mono font-bold"></span>
                </div>
              {% endif %}
              <div class="text-sm text-gray-600 dark:text-gray-400">
                <span class="font-medium">Progress:</span>
                <span id="question-progress">1</span> of {{ questions|length }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Quiz Form -->
      <form id="quiz-form" method="post" action="{% url 'take_quiz' quiz.id %}">
        {% csrf_token %}
        <input type="hidden" name="quiz_id" value="{{ quiz_id }}" />
        <input type="hidden" name="user_quiz_id" value="{{ user_quiz.id }}" />
        <input type="hidden" id="quiz_timer_value" name="quiz_timer_value" value="" />
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
          <div class="p-6">
            <!-- Questions -->
            <div class="space-y-8" id="questions-container">
              {% for question in questions %}
                <div class="question-item {% if not forloop.first %}hidden{% endif %}"
                     data-question-index="{{ forloop.counter }}">
                  <div class="flex items-center mb-4">
                    <span class="inline-flex items-center justify-center bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200 text-sm font-medium rounded-full h-8 w-8 mr-3">
                      {{ forloop.counter }}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium  bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300 ">
                      {{ question.question_type_display }}
                    </span>
                    {% if question.points %}
                      <span class="ml-2 items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-purple-900 dark:text-purple-300 ">
                        Points: {{ question.points }}
                      </span>
                    {% endif %}
                  </div>
                  <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">{{ question.text }}</h2>
                  <div class="ml-4">
                    {% if question.question_type == 'multiple' %}
                      <div class="space-y-2">
                        {% for option in question.options %}
                          <div class="flex items-center">
                            <input type="checkbox"
                                   id="question_{{ question.id }}_option_{{ option.id }}"
                                   name="question_{{ question.id }}[]"
                                   value="{{ option.id }}"
                                   class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded" />
                            <label for="question_{{ question.id }}_option_{{ option.id }}"
                                   class="ml-3 block text-gray-700 dark:text-gray-300">{{ option.text }}</label>
                          </div>
                        {% endfor %}
                      </div>
                    {% elif question.question_type == 'true_false' %}
                      <div class="space-y-2">
                        {% for option in question.options %}
                          <div class="flex items-center">
                            <input type="radio"
                                   id="question_{{ question.id }}_option_{{ option.id }}"
                                   name="question_{{ question.id }}"
                                   value="{{ option.id }}"
                                   class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded" />
                            <label for="question_{{ question.id }}_option_{{ option.id }}"
                                   class="ml-3 block text-gray-700 dark:text-gray-300">{{ option.text }}</label>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div>
                        <textarea name="question_{{ question.id }}"
                                  rows="4"
                                  class="w-full px-3 py-2 text-gray-700 dark:text-gray-300 border rounded-lg focus:outline-none focus:border-teal-500 dark:bg-gray-700 dark:border-gray-600"
                                  placeholder="Type your answer here..."></textarea>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8">
              <button type="button"
                      id="prev-btn"
                      class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hidden">
                <i class="fas fa-arrow-left mr-2"></i> Previous
              </button>
              <div class="ml-auto flex space-x-4">
                <button type="button"
                        id="next-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                  Next <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button type="submit"
                        id="submit-btn"
                        class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-lg hidden">
                  <i class="fas fa-check mr-2"></i> Submit Quiz
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const questions = document.querySelectorAll('.question-item');
          const prevBtn = document.getElementById('prev-btn');
          const nextBtn = document.getElementById('next-btn');
          const submitBtn = document.getElementById('submit-btn');
          const progressCounter = document.getElementById('question-progress');

          let currentQuestionIndex = 0;
          const totalQuestions = questions.length;

          // Show the current question and hide others
          function showQuestion(index) {
              questions.forEach((q, i) => {
                  if (i === index) {
                      q.classList.remove('hidden');
                  } else {
                      q.classList.add('hidden');
                  }
              });

              // Update progress counter
              progressCounter.textContent = index + 1;

              // Update button visibility
              prevBtn.classList.toggle('hidden', index === 0);

              if (index === totalQuestions - 1) {
                  nextBtn.classList.add('hidden');
                  submitBtn.classList.remove('hidden');
              } else {
                  nextBtn.classList.remove('hidden');
                  submitBtn.classList.add('hidden');
              }
          }

          // Event listeners for navigation buttons
          prevBtn.addEventListener('click', function() {
              if (currentQuestionIndex > 0) {
                  currentQuestionIndex--;
                  showQuestion(currentQuestionIndex);
              }
          });

          nextBtn.addEventListener('click', function() {
              if (currentQuestionIndex < totalQuestions - 1) {
                  currentQuestionIndex++;
                  showQuestion(currentQuestionIndex);
              }
          });

          // Initialize
          showQuestion(currentQuestionIndex);
      });
  </script>
{% endblock content %}
