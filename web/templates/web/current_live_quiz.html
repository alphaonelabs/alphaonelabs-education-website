{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6 relative">
  <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 relative">
    <div
      class="absolute top-6 right-6 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg"
    >
      ‚è≥ <span id="countdown-timer">{{quiz.duration_minutes}}:00</span>
    </div>

    {% if quiz %}
    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">
      üèÜ {{ quiz.title }}
    </h2>

    <p class="text-gray-700 dark:text-gray-300 mb-4">{{ quiz.description }}</p>

    {% if has_submitted %}
    <p class="text-green-600 dark:text-green-400 font-semibold">
      ‚úÖ You have already submitted this quiz.
    </p>
    {% else %}
    <form id="quiz-form" method="post" action="{% url 'submit_quiz' quiz.id %}">
      {% csrf_token %} {% for question in quiz.questions.all %}
      <div class="mb-4">
        <p class="text-lg font-semibold">{{ question.question_text }}</p>
        {% for option in question.options.all %}
        <label class="block mt-2">
          <input
            type="radio"
            name="question_{{ question.id }}"
            value="{{ option.id }}"
            required
          />
          {{ option.option_text }}
        </label>
        {% endfor %}
      </div>
      {% endfor %}

      <button
        type="submit"
        id="submit-button"
        class="mt-4 bg-teal-600 text-white px-5 py-2.5 rounded-lg hover:bg-teal-700 transition-shadow shadow-md"
      >
        Submit Quiz
      </button>
    </form>
    {% endif %} {% else %}
    <p class="text-gray-500 dark:text-gray-400 text-lg">
      No active quiz at the moment.
    </p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const quizForm = document.getElementById("quiz-form");
    const submitButton = document.getElementById("submit-button");
    const timerElement = document.getElementById("countdown-timer");
    const quizId = "{{ quiz.id }}";
    const quizDuration = {{ quiz.duration_minutes }} * 60;

    function getTimeLeft() {
      const savedData = JSON.parse(localStorage.getItem(storageKey));

      if (savedData) {
        const elapsedTime = Math.floor((Date.now() - savedData.startTime) / 1000);
        return Math.max(savedData.remainingTime - elapsedTime, 0);
      }
      return quizDuration;
    }

    function saveTimeLeft(timeLeft) {
      localStorage.setItem(storageKey, JSON.stringify({
        startTime: Date.now(),
        remainingTime: timeLeft
      }));
    }

    function updateTimerDisplay(timeLeft) {
      let minutes = Math.floor(timeLeft / 60);
      let seconds = timeLeft % 60;
      timerElement.innerText = `${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    let timeLeft = getTimeLeft();
    updateTimerDisplay(timeLeft);

    function updateTimer() {
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        localStorage.removeItem(storageKey);
        alert("‚è≥ Time is up! Your quiz will be submitted automatically.");
        quizForm.submit();
        return;
      }

      if (timeLeft === 60) {
        timerElement.classList.add("animate-pulse", "bg-yellow-500");
        const warningDiv = document.createElement("div");
        warningDiv.className = "my-4 p-3 bg-yellow-100 text-yellow-700 rounded-lg";
        warningDiv.innerHTML = "‚ö†Ô∏è <strong>1 minute remaining!</strong> Please submit your quiz soon.";
        quizForm.prepend(warningDiv);
      }

      updateTimerDisplay(timeLeft);
      saveTimeLeft(timeLeft);
      timeLeft--;
    }

    const timerInterval = setInterval(updateTimer, 1000);

    // Confirmation before submitting
    quizForm.addEventListener("submit", function (e) {
      if (!confirm("Are you sure you want to submit your quiz?")) {
        e.preventDefault();
        return false;
      }
      localStorage.removeItem(storageKey);
    });
  });
</script>
{% endblock %}