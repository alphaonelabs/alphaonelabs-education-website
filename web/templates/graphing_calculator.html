{% extends "base.html" %}

{% block title %}Graphing Calculator{% endblock %}
{% block content %}
  <div class="flex flex-col md:flex-row h-screen bg-gray-100 dark:bg-gray-900">
    <!-- Sidebar -->
    <div class="w-full md:w-80 bg-white dark:bg-gray-800 shadow-lg p-4 overflow-y-auto">
      <h1 class="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-white">Graphing Calculator</h1>
      <!-- Input and Add Function -->
      <div class="mb-6">
        <label for="equationInput"
               class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Enter Function</label>
        <div class="flex space-x-2">
          <input type="text"
                 id="equationInput"
                 placeholder="e.g., sin(x)"
                 class="flex-grow p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:text-white text-sm" />
          <button onclick="addEquation()"
                  class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none">Add</button>
        </div>
        <p id="errorText" class="text-red-500 text-sm mt-1 hidden"></p>
      </div>
      <!-- Function List -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Functions</h2>
        <div id="functionList" class="space-y-2 max-h-40 overflow-y-auto">
          <!-- Functions will be added here dynamically -->
        </div>
        <button onclick="clearAll()"
                class="mt-2 w-full px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 focus:outline-none text-sm">
          Clear All
        </button>
      </div>
      <!-- Quick Examples -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Examples</h2>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="addExample('y = x^2')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Parabola
          </button>
          <button onclick="addExample('y = sin(x)')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Sine Wave
          </button>
          <button onclick="addExample('asin(x)')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Arcsin
          </button>
          <button onclick="addExample('y = tan(x)')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Tangent
          </button>
          <button onclick="addExample('y = log(x)')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Logarithm
          </button>
          <button onclick="addExample('y = exp(x)')"
                  class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
            Exponential
          </button>
        </div>
      </div>
      <!-- Zoom and Navigation Controls -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Controls</h2>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <button onclick="zoomIn()"
                  class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none text-sm">
            Zoom In
          </button>
          <button onclick="resetView()"
                  class="p-2 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none text-sm">
            Reset
          </button>
          <button onclick="zoomOut()"
                  class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none text-sm">
            Zoom Out
          </button>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <button onclick="panLeft()"
                  class="p-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 text-sm">
            ← Pan
          </button>
          <button onclick="panUp()"
                  class="p-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 text-sm">
            ↑ Pan
          </button>
          <button onclick="panRight()"
                  class="p-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 text-sm">
            Pan →
          </button>
          <button onclick="toggleGridLines()"
                  class="p-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 text-sm">
            Toggle Grid
          </button>
          <button onclick="panDown()"
                  class="p-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 text-sm">
            ↓ Pan
          </button>
          <button onclick="exportImage()"
                  class="p-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">Export</button>
        </div>
      </div>
    </div>
    <!-- Main Graph Area -->
    <div class="flex-grow p-4 flex items-center justify-center">
      <div class="relative w-full h-full max-w-4xl max-h-3xl">
        <div id="graphCanvas" class="border rounded-lg shadow bg-white dark:bg-gray-700 w-full h-full"></div>
      </div>
    </div>
  </div>
  <!--https://mauriciopoppe.github.io/function-plot/ open source is used here-->
  <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
  <script>
        let container = document.getElementById("graphCanvas");
        let width = container.clientWidth;
        let height = container.clientHeight;
        let showGrid = true;
        let isDarkMode = false;
        let xDomain = [-10,10];
        let yDomain = [-10,10];
        let equations = [];
        let colors = ["#3B82F6", "#EF4444", "#10B981", "#F59E0B", "#8B5CF6", "#EC4899"];
        let plot = null // to store the chart instnace (functionPlot return a chart instance)

        function drawCanvasAndFunctions() {
            
            let visableFunctions = equations.filter(eq => eq.visible)

            plot = functionPlot({
                target: `#graphCanvas`,
                width,
                height,
                grid: showGrid,
                xAxis: {domain: xDomain},
                yAxis: {domain: yDomain},
                disableZoom: true, // use control buttons instead
                data: visableFunctions.map(eq => ({fn:eq.text , color:eq.color, skipTip:true}))
            });
        }

        function redraw() {
            drawCanvasAndFunctions();
        }


      window.addEventListener('load', drawCanvasAndFunctions); 
      window.addEventListener('resize', drawCanvasAndFunctions);


        function showError(message) {
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorText.classList.remove('hidden');
            
            setTimeout(function() {
                errorText.classList.add('hidden');
            }, 3000);
        }

        function isValidEquation(equation) {
            try {
                const testDiv = document.createElement('div');
                testDiv.id = 'testDiv'
                testDiv.style.display = 'none';
                document.body.appendChild(testDiv);

                functionPlot({
                    target: '#testDiv',
                    width: 200,
                    height: 200,
                    data: [{
                        fn: equation
                    }]
                })

                document.body.removeChild(testDiv);
                return true;
            } catch(err) {
                return false;
            }
        }

        function addEquation() {
            const eqInput = document.getElementById('equationInput');
            let equation = eqInput.value.trim();
            
            if(!equation) {
                showError("Please enter a function!");
                eqInput.value = '';
                return;
            }
            
            if(!isValidEquation(equation)) {
                showError("Invalid function!");
                eqInput.value = '';
                return;
            }

            if (equation) {
                const colorIndex = equations.length % colors.length;
                equations.push({
                    text: equation,
                    color: colors[colorIndex],
                    visible: true
                });
                updateFunctionList();
                redraw();
                eqInput.value = '';
            }
        }

      function removeEquation(index) {
          equations.splice(index, 1);
          updateFunctionList();
          redraw();
      }

      function toggleEquationVisibility(index) {
          equations[index].visible = !equations[index].visible;
          updateFunctionList();
          redraw();
      }

      function clearAll() {
          equations = [];
          updateFunctionList();
          redraw();
      }

      function addExample(equation) {
          document.getElementById('equationInput').value = equation;
          addEquation();
      }

      function updateFunctionList() {
          const listContainer = document.getElementById('functionList');
          listContainer.innerHTML = '';
          equations.forEach((eq, index) => {
              const item = document.createElement('div');
              item.className = 'flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded';
              const leftSection = document.createElement('div');
              leftSection.className = 'flex items-center space-x-2';
              const colorIndicator = document.createElement('div');
              colorIndicator.className = 'w-3 h-3 rounded-full';
              colorIndicator.style.backgroundColor = eq.color;
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.checked = eq.visible;
              checkbox.className = 'rounded text-blue-600';
              checkbox.onclick = () => toggleEquationVisibility(index);
              const text = document.createElement('span');
              text.className = 'text-sm text-gray-800 dark:text-gray-200';
              text.textContent = eq.text;
              leftSection.appendChild(colorIndicator);
              leftSection.appendChild(checkbox);
              leftSection.appendChild(text);
              const deleteBtn = document.createElement('button');
              deleteBtn.innerHTML = '&times;';
              deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold';
              deleteBtn.onclick = () => removeEquation(index);
              item.appendChild(leftSection);
              item.appendChild(deleteBtn);
              listContainer.appendChild(item);
          });
      }

        function zoomIn() {
            const xRange = (xDomain[1] - xDomain[0]) * 0.4; 
            const yRange = (yDomain[1] - yDomain[0]) * 0.4;
            const xCenter = (xDomain[0] + xDomain[1]) / 2;
            const yCenter = (yDomain[0] + yDomain[1]) / 2;
            xDomain = [xCenter - xRange, xCenter + xRange];
            yDomain = [yCenter - yRange, yCenter + yRange];
            redraw();
        }

        function zoomOut() {
            const xRange = (xDomain[1] - xDomain[0]) * 0.6;  
            const yRange = (yDomain[1] - yDomain[0]) * 0.6;
            const xCenter = (xDomain[0] + xDomain[1]) / 2;
            const yCenter = (yDomain[0] + yDomain[1]) / 2;
            xDomain = [xCenter - xRange, xCenter + xRange];
            yDomain = [yCenter - yRange, yCenter + yRange];
            redraw();
        }

        function resetView() {
            xDomain = [-10, 10];
            yDomain = [-10, 10];
            redraw();
        }

        function panLeft() {
            const shift = (xDomain[1] - xDomain[0]) * 0.2;
            xDomain = [xDomain[0] - shift, xDomain[1] - shift];
            redraw();
        }

        function panRight() {
            const shift = (xDomain[1] - xDomain[0]) * 0.2;
            xDomain = [xDomain[0] + shift, xDomain[1] + shift];
            redraw();
        }

        function panUp() {
            const shift = (yDomain[1] - yDomain[0]) * 0.2;
            yDomain = [yDomain[0] + shift, yDomain[1] + shift];
            redraw();
        }

        function panDown() {
            const shift = (yDomain[1] - yDomain[0]) * 0.2;
            yDomain = [yDomain[0] - shift, yDomain[1] - shift];
            redraw();
        }

      function toggleGridLines() {
          showGrid = !showGrid;
          redraw();
      }


        function exportImage() {
            const svg = document.querySelector('#graphCanvas svg');
            if (!svg) {
                showError("No graph to export!");
                return;
            }
            
            // Clone SVG and set background
            const svgClone = svg.cloneNode(true);
            svgClone.style.backgroundColor = '#ffffff';
            
            // Convert SVG to data URL
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);
            
            // Create image and draw to canvas
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = svg.clientWidth * 2;  // 2x for better quality
                canvas.height = svg.clientHeight * 2;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.scale(2, 2);
                ctx.drawImage(img, 0, 0);
                
                // Download
                const link = document.createElement('a');
                link.download = 'graph.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }
  </script>
{% endblock %}
